= spring-hystrix-correlation-id

correlation ID implementation with Spring and Hystrix

== What is a correlation ID ?

When working with micro-services, tracing the root cause of an issue can quickly become a headache.
Requests are passed from a system to another, and a simple stack trace may not bear the information you need.

The correlation ID is a simple diagnostic tool.
Basically, we assign a unique identifier to each request and the sub-requests to resolve this transaction will bear this identifier.
 which involves requests going through several sub systems is assigned a correlation ID.
This unique identifier is passed along with  for a business transaction across several sub systems.
This identifier is shared across several systems so that each system can print logs with this correlation ID.

This way, it's possible to aggregate all the logs related to a single business transaction.

This practice is sometimes refered as "distributed tracing".

== How does it work ?

A simple solution is to pass the correlation ID from one system to another as a http header.

== How does it work with Hystrix ?
 
ThreadLocal won't do
the correlation-id is a cross-cuting concern. We don't want to add noise to our business code.

== And now the code

=== Tests
2 tests demonstrate that:

* the correlation is passed accross services
* it is generated if not provided by the caller

[source,java]
.DemoTests.java
----
@Test
public void correlation_ID_is_passed_across_services() {

    // initialize mock server, expecting a request with a specific correlation ID
    mockServer.expect(requestTo("http://remote/service"))
            .andExpect(header("X-Correlation-ID", "123e4567-e89b-12d3-a456-426655440000"))
            .andRespond(withSuccess());

    // call demo with correlation ID
    httpGet("/demo", headers("X-Correlation-ID", "123e4567-e89b-12d3-a456-426655440000"));

    // verify expectations
    mockServer.verify();
}
----

[source,java]
----
@Test
public void correlation_ID_is_generated_if_missing() {

    // initialize mock server, expecting a request with any correlation ID
    mockServer.expect(requestTo("http://remote/service"))
            .andExpect(header("X-Correlation-ID", anything()))
            .andRespond(withSuccess());

    // call demo without correlation ID
    httpGet("/demo", noHeaders());

    // verify expectations
    mockServer.verify();
}
----

[caption="Several threads are involved but the correlation ID is unchanged"]image::logs.jpg[]

== resources

* http://samnewman.io/talks/principles-of-microservices/
* https://dzone.com/articles/implementing-correlation-ids-0